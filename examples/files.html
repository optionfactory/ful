<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" integrity="sha256-oxqX0LQclbvrsJt8IymkxnISn4Np2Wy2rY9jjoQlDEg=" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha256-y3ibfOyBqlgBd+GzwFYQEVOZdNJD06HeDXihongBXKs=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.bootstrap5.min.css" integrity="sha256-lQMtfzgdbG8ufMCU5UThXG65Wsv5CIXGkHFGCHA68ME=" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js" integrity="sha256-t5cAXPIzePs4RIuA3FejMxOlxXe4QXZXQ7sfKJxNU+Y=" crossorigin="anonymous"></script>

    <script src="../node_modules/@optionfactory/ftl/dist/ftl.iife.js"></script>
    <link href="../dist/ful.css" rel="stylesheet">
    <script src="../dist/ful.iife.min.js"></script>
    <style>
        .warning {
            margin: 0.5rem 0;
            padding: 15px;
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
            border-radius: 8px;
            animation: show-and-hide 5s ease forwards;
            animation-composition: initial;
        }

        @keyframes show-and-hide {
            0% {
                opacity: 0;
                display: block;
            }
            3% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                display: none;
            }
        }
    </style>
    <style>
        ful-input-file {
            &>.dropzone {
                border: 5px solid blue;
                min-height: 100px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            &>.items {
                display: grid;
                grid-template-columns: 1fr auto auto;
                gap: 4px;

                &>.item:first-of-type {
                    margin-top: 6px;
                }

                &>.item:last-of-type {
                    margin-bottom: 6px;
                }

                &>.item {
                    display: grid;
                    grid-column: 1 / -1;
                    grid-template-columns: subgrid;
                    align-items: center;

                    &>.filename {
                        min-width: 30px;
                        display: inline-block;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }

                    &>.size {
                        text-align: right;
                    }
                }
            }
        }
    </style>
    <script>



        class InputFile extends ful.Input {
            static l10n = {
                en: {
                    'unaccepptablefiletype': "unsupported file type has been discarded",
                    'maxfilesizeexceeded': "max file size exceeded",
                    'maxtotalsizeexceeded': "total file size exceeded"
                },
                it: {
                    'unaccepptablefiletype': "unsupported file type has been discarded",
                    'maxfilesizeexceeded': "max file size exceeded",
                    'maxtotalsizeexceeded': "total file size exceeded"
                }
            }
            static observed = ['value', 'readonly:presence', 'multiple:presence', "accept:csv", "maxfilesize:number", "maxtotalsize:number"];
            #accept;
            #items;
            #dropzone;
            #warnings;
            _type() {
                return 'file';
            }
            static template = `
                <div class="form-label">
                    <label>{{{{ slots.default }}}}</label>
                    {{{{ slots.info }}}}
                </div>
                <div data-tpl-class="slots.dropzone ? 'input-group d-none': 'input-group'">
                    <span data-tpl-if="slots.ibefore" class="input-group-text">{{{{ slots.ibefore }}}}</span>
                    {{{{ slots.before }}}}
                    <input class="form-control" data-tpl-type="type" placeholder=" " form="">
                    {{{{ slots.after }}}}
                    <span data-tpl-if="slots.iafter" class="input-group-text">{{{{ slots.iafter }}}}</span>
                </div>
                <div data-ref="dropzone" class="dropzone" data-tpl-if="slots.dropzone">
                    {{{{ slots.dropzone }}}}
                </div>
                <div data-ref="items" class="items"></div>
                <div data-ref="warnings" class="warnings"></div>
                <ful-field-error></ful-field-error>
            `;
            static templates = {
                items: `
                    <div class="item" data-tpl-each="files" data-tpl-var="file" data-tpl-data-name="file.name">
                        <div class="filename"><span>{{ file.name }}</span></div>
                        <div class="size">{{ #bytes:format(file.size) }}</div>
                        <button class="btn btn-sm btn-outline-danger"><i class="bi bi-x-lg"></i></button>
                    </div>
                `,
                warning: `
                    <div class="warning">
                        {{ #l10n:t(key, args) }}
                    </div>
                `
            }
            render(conf) {
                const { observed } = conf;
                super.render(conf);
                this.#items = this.querySelector("[data-ref=items]");
                this.#dropzone = this.querySelector("[data-ref=dropzone]");
                this.#warnings = this.querySelector("[data-ref=warnings]");
                this.multiple = observed.multiple;
                this.accept = observed.accept;
                this.maxfilesize = observed.maxfilesize;
                this.maxtotalsize = observed.maxtotalsize;
                this.#warnings.addEventListener('animationend', e => {
                    e.target.remove();
                });
                this.#items.addEventListener('click', (e) => {
                    if (!e.target.closest("button")) {
                        return;
                    }
                    const fileName = e.target.closest(".item").dataset.name;
                    const dt = new DataTransfer();
                    [...this.files].filter(f => f.name !== fileName).forEach(f => dt.items.add(f));
                    this.files = dt.files;
                    this.#update();
                })
                this.#dropzone?.addEventListener("click", (e) => {
                    this.querySelector('input').click();
                });

                this.#dropzone?.addEventListener("dragover", (e) => {
                    e.preventDefault();
                });
                this.#dropzone?.addEventListener("drop", (e) => {
                    e.preventDefault();
                    const dt = new DataTransfer();
                    [...e.dataTransfer.items].filter(i => i.kind === 'file').forEach(i => dt.items.add(i.getAsFile()));
                    this.files = dt.files;
                    this.#update();
                });
                this._input.addEventListener("change", (e) => {
                    this.#update();
                });
            }
            #update() {
                this.setCustomValidity();
                this.#ensureAcceptable();
                this.#ensureFileSizes();
                this.#ensureTotalSize();
                this.template('items').withOverlay({ files: this.files }).withModule('bytes', {
                    format: (v) => {
                        return (v > 1024 * 1024) ? `${Math.round(v / 1024 / 1024 * 100) / 100}MiB` : (v > 1024 ? `${Math.round(v / 1024 * 100) / 100}KiB` : `${v}B`);
                    }
                }).renderTo(this.#items);
            }
            #warning(key, args) {
                this.template('warning').withOverlay({key, args}).renderTo(this.#warnings);
            }
            #ensureAcceptable() {
                if (!this.#accept) {
                    return;
                }
                const unacceptable = [...this.files]
                    .filter(file => this.#accept.some(type => !file.name.toLowerCase().endsWith(type.toLowerCase())));

                if (unacceptable.length === 0) {
                    return;
                }
                this.#warning('unaccepptablefiletype');
                const dt = new DataTransfer();
                [...this.files].filter(f => !unacceptable.includes(f)).forEach(f => dt.items.add(f));
                this.files = dt.files;
            }
            #ensureFileSizes() {
                if (this.#maxfilesize === null) {
                    return;
                }
                const oversized = [...this.files]
                    .filter(file => file.size > this.#maxfilesize);
                if (oversized.length === 0) {
                    return;
                }
                this.#warning('maxfilesizeexceeded');
                const dt = new DataTransfer();
                [...this.files].filter(f => !oversized.includes(f)).forEach(f => dt.items.add(f));
                this.files = dt.files;
            }
            #ensureTotalSize() {
                if (this.#maxtotalsize === null) {
                    return;
                }
                const totalSize = [...this.files].reduce((acc, file) => acc + file.size, 0);
                if (totalSize <= this.#maxtotalsize) {
                    return;
                }
                this.#warning('maxtotalsizeexceeded');
                this.files = new DataTransfer().files;
            }
            get accept() {
                return this.#accept;
            }
            set accept(vs) {
                this._input.accept = vs.join(",");
                this.#accept = vs;
                this.reflect(() => {
                    this.setAttribute('accept', this._input.accept);
                })
            }
            get multiple() {
                return this._input.multiple;
            }
            set multiple(v) {
                this._input.multiple = v;
                this.reflect(() => {
                    this.setAttribute('multiple', this._input.accept);
                })
            }
            get files() {
                return this._input.files;
            }
            set files(vs) {
                return this._input.files = vs;
            }
            get file() {
                return this.files[0] ?? null;
            }
            set file(v) {
                const dt = new DataTransfer();
                dt.items.add(v);
                this.files = dt.files;
            }
            get value() {
                const names = Array.from(this._input.files).map(f => f.name);
                return this.multiple ? names : (names[0] ?? null);
            }
            set value(v) {
                //TODO:
            }
            #maxfilesize;
            get maxfilesize() {
                return this.#maxfilesize;
            }
            set maxfilesize(v) {
                this.#maxfilesize = v;
                this.reflect(() => {
                    this.setAttribute('maxfilesize', v);
                })

            }
            #maxtotalsize;
            get maxtotalsize() {
                return this.#maxtotalsize;
            }
            set maxtotalsize(v) {
                this.#maxtotalsize = v;
                this.reflect(() => {
                    this.setAttribute('maxtotalsize', v);
                })
            }

        }



        ftl.registry
            .plugin(new ful.Plugin())
            .defineElement("ful-input-file", InputFile)
            .defineComponent("response:mapper:posts", (data) => data.map(e => ([e.id, e.title, e])))
            .configure();
    </script>
    <style>
        ful-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }

        ful-form form {
            display: contents;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">

            <div class="warning">
                Test
            </div>

            <ful-form class="col-6 border border-primary gap-4">
                <h1>ful-input-file</h1>
                <ful-input-file>
                    Single
                </ful-input-file>
                <ful-input-file>
                    Single with dropzone
                    <span slot="dropzone">Drop your file here</span>
                </ful-input-file>
                <ful-input-file multiple>
                    Multiple
                </ful-input-file>
                <ful-input-file multiple>
                    Multiple with dropzone
                    <span slot="dropzone">Drop your file here</span>
                </ful-input-file>
                <ful-input-file multiple accept=".svg">
                    Multiple, accept .svg
                </ful-input-file>
                <ful-input-file multiple accept=".svg">
                    Multiple, accept .svg with dropzone
                    <span slot="dropzone">Drop your file here</span>
                </ful-input-file>
                <ful-input-file multiple maxfilesize="1024">
                    Multiple, maxfilesize 1024
                </ful-input-file>
                <ful-input-file multiple maxfilesize="1024">
                    Multiple, maxfilesize 1024 with dropzone
                    <span slot="dropzone">Drop your file here</span>
                </ful-input-file>

            </ful-form>
        </div>
    </div>
</body>

</body